# F2.T2: Image Preprocessor

## Agent: DOTNET_SENIOR

## Task Overview
Implement image preprocessing pipeline that converts raw screenshots into tensors suitable for neural network input.

## Context
Project: `src/TzarBot.NeuralNetwork/`. Use OpenCvSharp4 for image processing.

## Requirements

1. Create interface:
   ```csharp
   public interface IImagePreprocessor
   {
       float[] ProcessFrame(ScreenFrame frame);
       float[] ProcessFrameStack(ScreenFrame[] frames);
       int OutputWidth { get; }
       int OutputHeight { get; }
       int OutputChannels { get; }
       int StackSize { get; }
   }
   ```

2. Create preprocessing config:
   ```csharp
   public class PreprocessingConfig
   {
       public int TargetWidth { get; set; } = 240;
       public int TargetHeight { get; set; } = 135;
       public bool ConvertToGrayscale { get; set; } = true;
       public int FrameStackSize { get; set; } = 4;
       public Rectangle? CropRegion { get; set; } = null;
   }
   ```

3. Implement `ImagePreprocessor`:
   ```csharp
   public class ImagePreprocessor : IImagePreprocessor
   {
       // Pipeline steps:
       // 1. Crop (if CropRegion specified)
       // 2. Resize (bilinear interpolation)
       // 3. Convert to grayscale (optional)
       // 4. Normalize to [0, 1]
       // 5. Flatten to float array
   }
   ```

4. Create `FrameBuffer` for temporal stacking:
   ```csharp
   public class FrameBuffer
   {
       private readonly Queue<float[]> _frames;
       private readonly int _maxSize;

       public void AddFrame(float[] processedFrame);
       public float[] GetStackedFrames();
       public bool IsFull { get; }
       public void Clear();
   }
   ```

5. Create tests:
   - Test_Resize_OutputDimensions
   - Test_Grayscale_SingleChannel
   - Test_Normalize_RangeZeroToOne
   - Test_FrameBuffer_Stacking
   - Test_ProcessingSpeed_Under10ms

## Technical Details
- Input: BGRA32 (4 channels, 8-bit)
- After grayscale: 1 channel
- After normalization: float [0, 1]
- Stacked output: (StackSize * OutputHeight * OutputWidth) floats
- Default: 4 * 135 * 240 = 129,600 floats

## Outputs
- `src/TzarBot.NeuralNetwork/Preprocessing/IImagePreprocessor.cs`
- `src/TzarBot.NeuralNetwork/Preprocessing/ImagePreprocessor.cs`
- `src/TzarBot.NeuralNetwork/Preprocessing/FrameBuffer.cs`
- `tests/TzarBot.Tests/Phase2/PreprocessorTests.cs`

## Test Command
```bash
dotnet test tests/TzarBot.Tests --filter "FullyQualifiedName~Phase2.Preprocessor"
```

## On Failure
If processing too slow:
1. Use SIMD operations where possible
2. Pre-allocate buffers
3. Consider GPU preprocessing with OpenCL
4. Profile to find bottleneck
