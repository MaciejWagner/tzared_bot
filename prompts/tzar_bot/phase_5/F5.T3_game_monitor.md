# F5.T3: GameMonitor

## Agent: QA_INTEGRATION

## Task Overview
Implement continuous game monitoring that tracks state changes and detects game end.

## Context
Project: `src/TzarBot.StateDetection/`. Build on GameStateDetector.

## Requirements

1. Create configuration:
   ```csharp
   public class MonitorConfig
   {
       public TimeSpan MaxGameDuration { get; set; } = TimeSpan.FromMinutes(30);
       public TimeSpan StuckTimeout { get; set; } = TimeSpan.FromMinutes(2);
       public TimeSpan PollingInterval { get; set; } = TimeSpan.FromMilliseconds(100);
       public int ConsecutiveUnknownThreshold { get; set; } = 30;
       public int StateChangeConfirmationCount { get; set; } = 3;
   }
   ```

2. Create `MonitorResult`:
   ```csharp
   public class MonitorResult
   {
       public GameOutcome Outcome { get; set; }
       public TimeSpan Duration { get; set; }
       public DateTime StartedAt { get; set; }
       public DateTime EndedAt { get; set; }
       public List<StateChangeEvent> StateHistory { get; set; }
       public string? ErrorMessage { get; set; }
       public ScreenFrame? FinalFrame { get; set; }
   }
   ```

3. Create interface:
   ```csharp
   public interface IGameMonitor
   {
       Task<MonitorResult> MonitorGameAsync(CancellationToken ct);
       GameState CurrentState { get; }
       TimeSpan ElapsedTime { get; }
       bool IsMonitoring { get; }

       event Action<StateChangeEvent>? OnStateChanged;
       event Action<GameState>? OnGameEnded;
       event Action<string>? OnWarning;
   }
   ```

4. Implement `GameMonitor`:
   - Poll for state changes
   - Require confirmation before state change
   - Detect timeout, crash, stuck
   - Check if game process is running
   - Calculate frame differences for activity

5. Create tests:
   - Test_Monitor_DetectsVictory
   - Test_Monitor_DetectsDefeat
   - Test_Monitor_DetectsTimeout
   - Test_Monitor_DetectsStuck
   - Test_StateChange_RequiresConfirmation
   - Test_Events_AreEmitted

## Outputs
- `src/TzarBot.StateDetection/Monitor/IGameMonitor.cs`
- `src/TzarBot.StateDetection/Monitor/GameMonitor.cs`
- `src/TzarBot.StateDetection/Monitor/MonitorConfig.cs`
- `src/TzarBot.StateDetection/Monitor/MonitorResult.cs`
- `tests/TzarBot.Tests/Phase5/GameMonitorTests.cs`

## Test Command
```bash
dotnet test tests/TzarBot.Tests --filter "FullyQualifiedName~Phase5.GameMonitor"
```
