# F5.T4: Stats Extraction (OCR)

## Agent: AI_SENIOR

## Task Overview
Implement extraction of game statistics from victory/defeat screen using OCR.

## Prerequisites
- Download Tesseract trained data (tessdata)
- Place in tessdata/ folder

## Context
Project: `src/TzarBot.StateDetection/`. Use Tesseract OCR.

## Requirements

1. Add NuGet package: Tesseract

2. Create `GameStats`:
   ```csharp
   public class GameStats
   {
       public int? UnitsBuilt { get; set; }
       public int? UnitsLost { get; set; }
       public int? UnitsKilled { get; set; }
       public int? BuildingsBuilt { get; set; }
       public int? BuildingsLost { get; set; }
       public int? BuildingsDestroyed { get; set; }
       public int? GoldGathered { get; set; }
       public int? WoodGathered { get; set; }
       public int? FoodGathered { get; set; }
       public TimeSpan? GameDuration { get; set; }
       public float OcrConfidence { get; set; }
       public Dictionary<string, string> RawValues { get; set; }
   }
   ```

3. Create configuration with regions of interest (relative coordinates 0-1)

4. Create interface:
   ```csharp
   public interface IStatsExtractor
   {
       GameStats ExtractStats(ScreenFrame frame);
       GameStats ExtractStats(Mat image);
       bool IsResultScreen(Mat image);
   }
   ```

5. Implement `OcrStatsExtractor`:
   - Configure Tesseract for number recognition
   - Preprocess image for OCR (grayscale, threshold, scale)
   - Extract text from regions
   - Parse numeric values

6. Create fallback `RegexStatsExtractor`:
   - OCR full stats panel
   - Use regex to extract numbers

7. Create tests:
   - Test_ExtractStats_FromVictoryScreen
   - Test_ExtractStats_FromDefeatScreen
   - Test_OcrPreprocessing_ImprovesAccuracy
   - Test_HandlesMissingValues
   - Test_ExtractionTime_Under500ms

## Outputs
- `src/TzarBot.StateDetection/Stats/IStatsExtractor.cs`
- `src/TzarBot.StateDetection/Stats/OcrStatsExtractor.cs`
- `src/TzarBot.StateDetection/Stats/GameStats.cs`
- `src/TzarBot.StateDetection/Stats/StatsConfig.cs`
- `tests/TzarBot.Tests/Phase5/StatsExtractionTests.cs`

## Test Command
```bash
dotnet test tests/TzarBot.Tests --filter "FullyQualifiedName~Phase5.StatsExtraction"
```

## Notes
- Download tessdata from: https://github.com/tesseract-ocr/tessdata
- Consider training custom model for game font
