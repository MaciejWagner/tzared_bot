# F5.T2: GameStateDetector

## Agent: AI_SENIOR

## Task Overview
Implement the core game state detection using template matching and image analysis.

## Context
Create new project `src/TzarBot.StateDetection/`. Use OpenCvSharp4.

## Requirements

1. Create `GameState` enum:
   ```csharp
   public enum GameState
   {
       Unknown, Loading, MainMenu, InGame, Paused, Victory, Defeat, Crashed
   }
   ```

2. Create `DetectionResult`:
   ```csharp
   public class DetectionResult
   {
       public GameState State { get; set; }
       public float Confidence { get; set; }
       public TimeSpan DetectionTime { get; set; }
       public Dictionary<string, float> TemplateScores { get; set; }
       public DateTime Timestamp { get; set; }
   }
   ```

3. Create interface:
   ```csharp
   public interface IGameStateDetector
   {
       DetectionResult Detect(ScreenFrame frame);
       DetectionResult Detect(Mat image);
       void ReloadTemplates();
       IReadOnlyDictionary<string, float> LastMatchScores { get; }
   }
   ```

4. Implement `TemplateMatchingDetector`:
   - Load templates from manifest
   - Use Cv2.MatchTemplate with CCoeffNormed
   - Priority detection: Victory/Defeat > Menu > InGame
   - Calculate confidence from match scores

5. Add color histogram analysis (backup method):
   - Victory = gold/green tones
   - Defeat = red tones

6. Create tests:
   - Test_Detect_VictoryScreen_ReturnsVictory
   - Test_Detect_DefeatScreen_ReturnsDefeat
   - Test_Detect_InGame_ReturnsInGame
   - Test_DetectionTime_Under50ms

## Outputs
- `src/TzarBot.StateDetection/TzarBot.StateDetection.csproj`
- `src/TzarBot.StateDetection/Detection/GameState.cs`
- `src/TzarBot.StateDetection/Detection/IGameStateDetector.cs`
- `src/TzarBot.StateDetection/Detection/TemplateMatchingDetector.cs`
- `src/TzarBot.StateDetection/Detection/DetectionResult.cs`
- `tests/TzarBot.Tests/Phase5/GameStateDetectorTests.cs`

## Test Command
```bash
dotnet test tests/TzarBot.Tests --filter "FullyQualifiedName~Phase5.GameStateDetector"
```

## Note
Create test_images/ folder with sample screenshots for testing.
