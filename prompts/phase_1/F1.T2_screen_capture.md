# Task F1.T2: Screen Capture Implementation

## Task ID
`F1.T2`

## Description
Implement screen capture using DXGI Desktop Duplication API.

## Prerequisites
- F1.T1 (Project Setup) completed
- Solution builds successfully

## Context Files to Read
- `src/TzarBot.GameInterface/TzarBot.GameInterface.csproj`
- `src/TzarBot.Common/Models/ScreenFrame.cs`
- `plans/1general_plan.md` (section 1.1)

## Instructions

### Step 1: Create ScreenFrame Model

If not already created, update `src/TzarBot.Common/Models/ScreenFrame.cs`:

```csharp
namespace TzarBot.Common.Models;

public enum PixelFormat
{
    BGRA32,
    RGB24,
    Grayscale8
}

public class ScreenFrame
{
    public required byte[] Data { get; init; }
    public required int Width { get; init; }
    public required int Height { get; init; }
    public required long TimestampTicks { get; init; }
    public required PixelFormat Format { get; init; }

    public int Stride => Width * GetBytesPerPixel();

    private int GetBytesPerPixel() => Format switch
    {
        PixelFormat.BGRA32 => 4,
        PixelFormat.RGB24 => 3,
        PixelFormat.Grayscale8 => 1,
        _ => throw new ArgumentOutOfRangeException()
    };
}
```

### Step 2: Create IScreenCapture Interface

Create `src/TzarBot.GameInterface/Capture/IScreenCapture.cs`:

```csharp
namespace TzarBot.GameInterface.Capture;

public interface IScreenCapture : IDisposable
{
    ScreenFrame? CaptureFrame();
    int Width { get; }
    int Height { get; }
    bool IsInitialized { get; }
}
```

### Step 3: Create ScreenCaptureException

Create `src/TzarBot.GameInterface/Capture/ScreenCaptureException.cs`:

```csharp
namespace TzarBot.GameInterface.Capture;

public class ScreenCaptureException : Exception
{
    public ScreenCaptureException(string message) : base(message) { }
    public ScreenCaptureException(string message, Exception inner) : base(message, inner) { }
}
```

### Step 4: Implement DxgiScreenCapture

Create `src/TzarBot.GameInterface/Capture/DxgiScreenCapture.cs`:

Use Vortice.Windows library to:
1. Create D3D11 device
2. Get DXGI output (monitor)
3. Create OutputDuplication
4. Capture frames using AcquireNextFrame
5. Copy frame to CPU-accessible staging texture
6. Map and read pixel data
7. Return as ScreenFrame with BGRA32 format

Key implementation notes:
- Handle DXGI_ERROR_WAIT_TIMEOUT (return null, no new frame)
- Handle DXGI_ERROR_ACCESS_LOST (reinitialize)
- Properly dispose all D3D resources
- Use staging texture for CPU read

### Step 5: Create Tests

Create `tests/TzarBot.Tests/Phase1/ScreenCaptureTests.cs`:

```csharp
namespace TzarBot.Tests.Phase1;

public class ScreenCaptureTests
{
    [Fact]
    public void CaptureFrame_ReturnsValidData()
    {
        using var capture = new DxgiScreenCapture();

        var frame = capture.CaptureFrame();

        Assert.NotNull(frame);
        Assert.True(frame.Data.Length > 0);
    }

    [Fact]
    public void ScreenFrame_HasCorrectDimensions()
    {
        using var capture = new DxgiScreenCapture();

        var frame = capture.CaptureFrame();

        Assert.NotNull(frame);
        Assert.True(frame.Width > 0);
        Assert.True(frame.Height > 0);
    }

    [Fact]
    public void BufferSize_MatchesDimensions()
    {
        using var capture = new DxgiScreenCapture();

        var frame = capture.CaptureFrame();

        Assert.NotNull(frame);
        Assert.Equal(frame.Width * frame.Height * 4, frame.Data.Length);
    }

    [Fact]
    public void ContinuousCapture_NoMemoryLeak()
    {
        using var capture = new DxgiScreenCapture();

        var initialMemory = GC.GetTotalMemory(true);

        for (int i = 0; i < 100; i++)
        {
            var frame = capture.CaptureFrame();
        }

        GC.Collect();
        var finalMemory = GC.GetTotalMemory(true);

        // Allow 10MB growth
        Assert.True(finalMemory - initialMemory < 10 * 1024 * 1024);
    }

    [Fact]
    public void CaptureRate_AtLeast10Fps()
    {
        using var capture = new DxgiScreenCapture();

        var sw = Stopwatch.StartNew();
        int frameCount = 0;

        while (sw.ElapsedMilliseconds < 1000)
        {
            var frame = capture.CaptureFrame();
            if (frame != null) frameCount++;
            Thread.Sleep(10);
        }

        Assert.True(frameCount >= 10, $"Only captured {frameCount} frames in 1 second");
    }
}
```

## Expected Output Files
- `src/TzarBot.GameInterface/Capture/IScreenCapture.cs`
- `src/TzarBot.GameInterface/Capture/DxgiScreenCapture.cs`
- `src/TzarBot.GameInterface/Capture/ScreenCaptureException.cs`
- `tests/TzarBot.Tests/Phase1/ScreenCaptureTests.cs`

## Validation
```bash
dotnet test tests/TzarBot.Tests --filter "FullyQualifiedName~Phase1.ScreenCapture"
```

Expected: All tests pass.

## On Failure
If tests fail:
1. Check if running with admin privileges
2. Verify GPU drivers are up to date
3. Check if desktop composition is enabled
4. Try WARP device (software renderer) as fallback

---
*Prompt for TzarBot Phase 1, Task 2*
