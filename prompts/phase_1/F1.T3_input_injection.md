# Task F1.T3: Input Injection Implementation

## Task ID
`F1.T3`

## Description
Implement mouse and keyboard input injection using Windows SendInput API.

## Prerequisites
- F1.T1 (Project Setup) completed

## Context Files to Read
- `src/TzarBot.GameInterface/TzarBot.GameInterface.csproj`
- `src/TzarBot.Common/Models/GameAction.cs`
- `plans/1general_plan.md` (section 1.2)

## Instructions

### Step 1: Create VirtualKey Enum

Create `src/TzarBot.GameInterface/Input/VirtualKey.cs` with common virtual key codes.

### Step 2: Create NativeMethods

Create `src/TzarBot.GameInterface/Input/NativeMethods.cs` with P/Invoke declarations:
- SendInput
- GetSystemMetrics
- INPUT structure
- MOUSEINPUT structure
- KEYBDINPUT structure
- MOUSEEVENTF flags
- KEYEVENTF flags

### Step 3: Create IInputInjector Interface

Create `src/TzarBot.GameInterface/Input/IInputInjector.cs`:

```csharp
namespace TzarBot.GameInterface.Input;

public interface IInputInjector
{
    void MoveMouse(int x, int y, bool absolute = true);
    void MoveMouseRelative(int dx, int dy);
    void LeftClick();
    void RightClick();
    void DoubleClick();
    void DragStart();
    void DragEnd();
    void PressKey(VirtualKey key);
    void ReleaseKey(VirtualKey key);
    void TypeKey(VirtualKey key);
    void TypeHotkey(VirtualKey modifier, VirtualKey key);
    TimeSpan MinActionDelay { get; set; }
}
```

### Step 4: Implement Win32InputInjector

Create `src/TzarBot.GameInterface/Input/Win32InputInjector.cs`:

Implementation notes:
1. Use SendInput for all input injection
2. Convert screen coordinates to normalized (0-65535) for absolute positioning
3. Implement cooldown between actions (default 50ms)
4. Thread-safe implementation
5. Handle coordinate clamping

Key methods:
```csharp
public void MoveMouse(int x, int y, bool absolute = true)
{
    // Convert to normalized coordinates for absolute mode
    // Send MOUSEINPUT via SendInput
}

public void LeftClick()
{
    // Send MOUSEEVENTF_LEFTDOWN
    // Delay
    // Send MOUSEEVENTF_LEFTUP
    // Enforce cooldown
}

public void TypeHotkey(VirtualKey modifier, VirtualKey key)
{
    // Press modifier
    // Press key
    // Release key
    // Release modifier
}
```

### Step 5: Create InputAction Model

Update `src/TzarBot.Common/Models/GameAction.cs`:

```csharp
namespace TzarBot.Common.Models;

public enum ActionType
{
    None,
    LeftClick,
    RightClick,
    DoubleClick,
    DragStart,
    DragEnd,
    Hotkey1, Hotkey2, Hotkey3, Hotkey4, Hotkey5,
    Hotkey6, Hotkey7, Hotkey8, Hotkey9, Hotkey0,
    CtrlHotkey1, CtrlHotkey2, CtrlHotkey3, CtrlHotkey4, CtrlHotkey5,
    ScrollUp, ScrollDown,
    Escape, Enter
}

public class GameAction
{
    public int MouseDeltaX { get; set; }
    public int MouseDeltaY { get; set; }
    public ActionType Type { get; set; }
    public float Confidence { get; set; }
}
```

### Step 6: Create Tests

Create `tests/TzarBot.Tests/Phase1/InputInjectorTests.cs`:

```csharp
namespace TzarBot.Tests.Phase1;

public class InputInjectorTests
{
    [Fact]
    public void MoveMouse_DoesNotThrow()
    {
        var injector = new Win32InputInjector();

        var exception = Record.Exception(() => injector.MoveMouse(500, 500));

        Assert.Null(exception);
    }

    [Fact]
    public void LeftClick_DoesNotThrow()
    {
        var injector = new Win32InputInjector();

        var exception = Record.Exception(() => injector.LeftClick());

        Assert.Null(exception);
    }

    [Fact]
    public void ActionCooldown_EnforcesMinDelay()
    {
        var injector = new Win32InputInjector();
        injector.MinActionDelay = TimeSpan.FromMilliseconds(100);

        var sw = Stopwatch.StartNew();
        injector.LeftClick();
        injector.LeftClick();
        sw.Stop();

        Assert.True(sw.ElapsedMilliseconds >= 100);
    }

    [Fact]
    public void RelativeMove_DoesNotThrow()
    {
        var injector = new Win32InputInjector();

        var exception = Record.Exception(() => injector.MoveMouseRelative(10, 10));

        Assert.Null(exception);
    }

    [Fact]
    public void TypeHotkey_DoesNotThrow()
    {
        var injector = new Win32InputInjector();

        var exception = Record.Exception(() =>
            injector.TypeHotkey(VirtualKey.Control, VirtualKey.A));

        Assert.Null(exception);
    }
}
```

## Expected Output Files
- `src/TzarBot.GameInterface/Input/IInputInjector.cs`
- `src/TzarBot.GameInterface/Input/Win32InputInjector.cs`
- `src/TzarBot.GameInterface/Input/VirtualKey.cs`
- `src/TzarBot.GameInterface/Input/NativeMethods.cs`
- `tests/TzarBot.Tests/Phase1/InputInjectorTests.cs`

## Validation
```bash
dotnet test tests/TzarBot.Tests --filter "FullyQualifiedName~Phase1.InputInjector"
```

Expected: All tests pass.

## On Failure
If input not working:
1. Check if target window is focused
2. Verify coordinates are within screen bounds
3. Some applications block SendInput - try different input methods
4. Check if running as administrator

---
*Prompt for TzarBot Phase 1, Task 3*
