# F2.T3: ONNX Network Builder

## Agent: AI_SENIOR

## Task Overview
Implement conversion from NetworkGenome to ONNX model format. This enables GPU-accelerated inference via ONNX Runtime.

## Context
Project: `src/TzarBot.NeuralNetwork/`. Use Microsoft.ML.OnnxRuntime for model operations.

## Requirements

1. Add NuGet packages:
   - Microsoft.ML.OnnxRuntime
   - Microsoft.ML.OnnxRuntime.Managed
   - Google.Protobuf (for ONNX format)

2. Create interface:
   ```csharp
   public interface INetworkBuilder
   {
       byte[] BuildModel(NetworkGenome genome);
       void SaveModel(NetworkGenome genome, string path);
       bool ValidateModel(byte[] modelData);
   }
   ```

3. Implement `OnnxNetworkBuilder`:
   ```csharp
   public class OnnxNetworkBuilder : INetworkBuilder
   {
       public byte[] BuildModel(NetworkGenome genome)
       {
           var graph = new GraphProto();
           // Add input tensor
           AddInput(graph, genome);
           // Add conv layers (fixed architecture)
           int weightOffset = 0;
           foreach (var conv in genome.ConvLayers)
           {
               weightOffset = AddConvLayer(graph, conv, genome.Weights, weightOffset);
           }
           // Flatten
           AddFlatten(graph);
           // Add dense layers
           foreach (var dense in genome.HiddenLayers)
           {
               weightOffset = AddDenseLayer(graph, dense, genome.Weights, weightOffset);
           }
           // Add output heads
           AddOutputHead(graph, genome);
           return SerializeModel(graph);
       }
   }
   ```

4. Create weight initializer:
   ```csharp
   public static class WeightInitializer
   {
       public static void XavierUniform(Span<float> weights, int fanIn, int fanOut);
       public static void HeNormal(Span<float> weights, int fanIn);
       public static void Zeros(Span<float> weights);
       public static void Ones(Span<float> weights);
   }
   ```

5. Create tests:
   - Test_BuildModel_CreatesValidOnnx
   - Test_Model_HasCorrectInputShape
   - Test_Model_HasCorrectOutputShape
   - Test_Model_LoadsInOnnxRuntime
   - Test_WeightPlacement_MatchesGenome

## Alternative Approach
If building ONNX programmatically is too complex, consider:
- Creating a simple feed-forward network in Python
- Exporting to ONNX
- Loading and modifying weights in C#

## Outputs
- `src/TzarBot.NeuralNetwork/Builder/INetworkBuilder.cs`
- `src/TzarBot.NeuralNetwork/Builder/OnnxNetworkBuilder.cs`
- `src/TzarBot.NeuralNetwork/Builder/WeightInitializer.cs`
- `tests/TzarBot.Tests/Phase2/NetworkBuilderTests.cs`

## Test Command
```bash
dotnet test tests/TzarBot.Tests --filter "FullyQualifiedName~Phase2.NetworkBuilder"
```

## On Failure
If ONNX building fails:
1. Use simpler architecture (dense-only) first
2. Validate with netron.app
3. Check ONNX opset version compatibility
4. Consider using Python ONNX tools for model creation
