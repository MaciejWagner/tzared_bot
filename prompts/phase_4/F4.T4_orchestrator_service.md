# F4.T4: Orchestrator Service

## Agent: DEVOPS_SENIOR

## Task Overview
Implement the orchestrator that coordinates multiple VMs for parallel training.

## Context
Project: `src/TzarBot.Orchestrator/`.

## Requirements

1. Create interface:
   ```csharp
   public interface IOrchestrator
   {
       Task InitializeAsync();
       Task ShutdownAsync();
       Task<GenerationResult> RunGenerationAsync(
           IEnumerable<NetworkGenome> genomes,
           CancellationToken ct);
       int ActiveWorkers { get; }
       int QueuedJobs { get; }
   }

   public class GenerationResult
   {
       public List<WorkItemResult> WorkItems { get; set; }
       public int TotalGamesPlayed { get; set; }
       public TimeSpan Duration { get; set; }
       public int Errors { get; set; }
   }

   public class WorkItemResult
   {
       public NetworkGenome Genome { get; set; }
       public GameResult? Result { get; set; }
       public string? Error { get; set; }
   }
   ```

2. Implement `TrainingOrchestrator`:
   - Manage VM pool
   - Distribute genomes to workers
   - Collect results
   - Handle failures
   - Parallel execution

3. Create work queue system:
   - Priority queue for genomes
   - Worker assignment
   - Result collection

4. Implement health monitoring:
   - Ping workers
   - Detect crashes
   - Auto-restart failed workers

5. Create tests:
   - Test_Initialize_StartsVMs
   - Test_RunGeneration_DistributesWork
   - Test_CollectsResults
   - Test_HandlesWorkerFailure

## Outputs
- `src/TzarBot.Orchestrator/TzarBot.Orchestrator.csproj`
- `src/TzarBot.Orchestrator/Core/IOrchestrator.cs`
- `src/TzarBot.Orchestrator/Core/TrainingOrchestrator.cs`
- `src/TzarBot.Orchestrator/Queue/WorkQueue.cs`
- `src/TzarBot.Orchestrator/Health/HealthMonitor.cs`
- `tests/TzarBot.Tests/Phase4/OrchestratorTests.cs`

## Test Command
```bash
dotnet test tests/TzarBot.Tests --filter "FullyQualifiedName~Phase4.Orchestrator"
```
