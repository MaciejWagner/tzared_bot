# F4.T5: Communication Protocol

## Agent: DOTNET_SENIOR

## Task Overview
Implement communication between orchestrator and worker VMs.

## Context
Project: `src/TzarBot.Communication/`.

## Requirements

1. Define message types:
   ```csharp
   public abstract class Message
   {
       public Guid MessageId { get; set; }
       public DateTime Timestamp { get; set; }
   }

   public class StartGameCommand : Message
   {
       public byte[] GenomeData { get; set; }
       public OpponentDifficulty Difficulty { get; set; }
       public TimeSpan Timeout { get; set; }
   }

   public class GameProgressUpdate : Message
   {
       public GameState State { get; set; }
       public TimeSpan ElapsedTime { get; set; }
   }

   public class GameCompleteMessage : Message
   {
       public GameResult Result { get; set; }
   }
   ```

2. Create TCP-based protocol:
   - MessagePack serialization
   - Length-prefixed messages
   - Heartbeat mechanism
   - Reconnection logic

3. Implement server (orchestrator side):
   ```csharp
   public interface IWorkerServer
   {
       Task StartAsync(int port);
       Task StopAsync();
       Task SendToWorkerAsync(int workerId, Message message);
       event Action<int, Message>? OnMessageReceived;
       event Action<int>? OnWorkerConnected;
       event Action<int>? OnWorkerDisconnected;
   }
   ```

4. Implement client (worker side):
   ```csharp
   public interface IWorkerClient
   {
       Task ConnectAsync(string host, int port);
       Task DisconnectAsync();
       Task SendAsync(Message message);
       event Action<Message>? OnMessageReceived;
       bool IsConnected { get; }
   }
   ```

5. Create tests:
   - Test_SendReceive_RoundTrip
   - Test_Reconnection_AfterDisconnect
   - Test_Heartbeat_DetectsFailure
   - Test_LargeMessage_Transfers

## Outputs
- `src/TzarBot.Communication/TzarBot.Communication.csproj`
- `src/TzarBot.Communication/Messages/*.cs`
- `src/TzarBot.Communication/Protocol/TcpWorkerServer.cs`
- `src/TzarBot.Communication/Protocol/TcpWorkerClient.cs`
- `tests/TzarBot.Tests/Phase4/CommunicationTests.cs`

## Test Command
```bash
dotnet test tests/TzarBot.Tests --filter "FullyQualifiedName~Phase4.Communication"
```
